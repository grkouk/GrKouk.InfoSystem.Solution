@page "{handler?}"
@model GrKouk.WebRazor.Pages.Transactions.BuyMaterialsDoc.CreateModel
@using Microsoft.Extensions.Configuration
@inject IConfiguration Configuration

@{
    ViewData["Title"] = "Create";
}
<style>
    .ui-autocomplete-loading {
        background: white url('@Url.Content("~/images/ui-anim_basic_16x16.gif")') right center no-repeat;
    }
</style>
<h4>Νέο παραστατικό αγοράς υλικών</h4>
<hr />
<div class="container">
    <form method="post">
        <fieldset id="thisForm">
            <div asp-validation-summary="ModelOnly" class="text-danger small"></div>

            <div class="form-row">
                <div class="form-group col-md-2">
                    <label asp-for="ItemVm.TransDate" class="control-label small "></label>
                    <input asp-for="ItemVm.TransDate" class="form-control form-control-sm small" />
                    <span asp-validation-for="ItemVm.TransDate" class="text-danger small"></span>
                </div>
                <div class="form-group col-md-7">
                    <label asp-for="ItemVm.MaterialDocSeriesId" class="control-label small"></label>
                    <select asp-for="ItemVm.MaterialDocSeriesId" class="form-control form-control-sm small" asp-items="ViewBag.MaterialDocSeriesId"></select>
                </div>
                <div class="form-group col-md-3">
                    <label asp-for="ItemVm.TransRefCode" class="control-label small"></label>
                    <input asp-for="ItemVm.TransRefCode" class="form-control form-control-sm small" />
                    <span asp-validation-for="ItemVm.TransRefCode" class="text-danger small"></span>

                </div>
            </div>
            <div class="form-row">
                <div class="form-group col-md-8">
                    <label asp-for="ItemVm.SupplierId" class="control-label small"></label>
                    <select asp-for="ItemVm.SupplierId" class="form-control form-control-sm small" asp-items="ViewBag.SupplierId"></select>
                </div>
                <div class="form-group col-md-4">
                    <label asp-for="ItemVm.CompanyId" class="control-label" small></label>
                    <select asp-for="ItemVm.CompanyId" class="form-control form-control-sm small" asp-items="ViewBag.CompanyId"></select>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group col-md-12">
                    <label asp-for="ItemVm.Etiology" class="control-label small"></label>
                    <textarea asp-for="ItemVm.Etiology" class="form-control form-control-sm small"></textarea>
                    <span asp-validation-for="ItemVm.Etiology" class="text-danger small"></span>
                </div>
            </div>
            <div class="form-row">
                <input type="hidden" id="MaterialId" />
                <input type="hidden" id="MaterialLastPrice" />
                <input type="hidden" id="MaterialFactor" />
                <input type="hidden" id="MaterialFpaId" />
                <div class="form-group col-sm-3">

                    <label class="small">LookUp</label>
                    <input class="form-control form-control-sm small" id="Lookup" />
                    <span class="text-danger small"></span>
                </div>

                <div class="form-group col-sm-2">
                    <label class="small" id="q1Label">Q1</label>
                    <input class="form-control form-control-sm small " type="number" min="10" placeholder="Q 1" id="Q1" />
                    <span class="text-danger small"></span>
                </div>
                <div class="form-group col-sm-2">
                    <label class="small" id="q2Label">Q2</label>
                    <input class="form-control form-control-sm small " type="number" placeholder="Q 2" id="Q2" />
                    <span class="text-danger small"></span>
                </div>
                <div class="form-group col-sm-2">
                    <label class="small">Price</label>
                    <input class="form-control form-control-sm small " type="number" placeholder="Price Net" id="Price" />
                    <span class="text-danger small"></span>
                </div>
                <div class="form-group col-sm-1">
                    <label class="small">Dis% </label>
                    <input class="form-control form-control-sm small " type="number" placeholder="Dis %" id="Discount" />
                    <span class="text-danger small"></span>
                </div>
                <div class="form-group col-sm-1">
                    <label class="small">VAT% </label>
                    <input class="form-control form-control-sm small " type="number" placeholder="Vat%" id="VatPercent" />
                    <span class="text-danger small"></span>
                </div>
                <div class="form-group col-sm-1 align-self-end">
                    <button id="addToList" class="btn btn-primary btn-sm">
                        <i class="far fa-arrow-alt-circle-down"></i>
                    </button>
                </div>
            </div>
            <div class="form-row">
                <table id="detailsTable" class="table table-responsive-sm">
                    <thead class="small">
                        <tr>
                            <th class="small" style="width: 0%"> Id</th>
                            <th class="small" style="width: 20%">Product</th>
                            <th class="small" style="width: 15%">Unit Price</th>
                            <th class="small" style="width: 15%">Unit Discount</th>
                            <th class="small" style="width: 15%">Q1</th>
                            <th class="small" style="width: 15%">Q2</th>
                            <th class="small" style="width: 10%">Amount</th>
                            <th class="small" style="width: 10%"></th>

                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <div class="form-row">

                <div class="form-group">
                    <label asp-for="ItemVm.AmountFpa" class="control-label small"></label>
                    <input asp-for="ItemVm.AmountFpa" class="form-control form-control-sm small" />
                    <span asp-validation-for="ItemVm.AmountFpa" class="text-danger"></span>
                </div>
                <div class="form-group">
                    <label asp-for="ItemVm.AmountNet" class="control-label small"></label>
                    <input asp-for="ItemVm.AmountNet" class="form-control form-control-sm small" />
                    <span asp-validation-for="ItemVm.AmountNet" class="text-danger"></span>
                </div>
                <div class="form-group">
                    <label asp-for="ItemVm.AmountDiscount" class="control-label small"></label>
                    <input asp-for="ItemVm.AmountDiscount" class="form-control form-control-sm small" />
                    <span asp-validation-for="ItemVm.AmountDiscount" class="text-danger"></span>
                </div>
            </div>

            <div class="form-group">
                <input type="submit" value="Create" class="btn btn-primary btn-sm" id="saveForm" />
            </div>
        </fieldset>
    </form>

</div>

<div>
    <a asp-page="Index">Back to List</a>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    <script src="~/lib/jqueryui/jquery-ui.min.js"></script>
    <script>
        $(document).ready(function() {
            console.log("Inside Document ready");
            var securityToken = $('[name=__RequestVerificationToken]').val();
            var $f = $('#MaterialFactor');
            var $q1 = $('#Q1');
            var $q2 = $('#Q2');

            $('#Q1').blur(function (event) {
                console.log("Q1 validation");
                $('#Q1').checkValidity();
            });
            $('#Price').blur(function(event) {
                event.target.checkValidity();
            });
            $('#Discount').blur(function(event) {
                event.target.checkValidity();
            });
            $('#VatPercent').blur(function(event) {
                event.target.checkValidity();
            });



            $('#Q1').change(() => {
                console.log("Q1 change event ->" + $q1.val());

                $q2.val($q1.val() / $f.val());

            });

            $('#Q2').change(() => {
                console.log("Q2 change event ->" + $q2.val());
                $q1.val($q2.val() * $f.val());

            });
            $('#ItemVm_TransDate').val(new Date().toISOString().slice(0, 10));


            $('#Lookup').autocomplete({
                source: '/api/materials/search',
                minLength: 2,
                select: function(event, ui) {
                    $('#MaterialId').val(ui.item.value);
                    console.log(ui.item.value.toString());
                    this.value = ui.item.label;
                    //Get Material data
                    const Uri = '@Configuration.GetSection("WebApiSettings")["WebApiLocal"]';
                    const FinalUri = `${Uri}/materials/materialdata?materialId=${ui.item.value}`;

                    console.log(FinalUri);

                    fetch(FinalUri)
                        .then(function(response) {
                            if (response.ok) {
                                return response.json();
                            } else {
                                return "";
                            }

                        })
                        .then(function(myJson) {
                            if (myJson) {
                                console.log(JSON.stringify(myJson));
                                var rate = myJson.fpaRate;
                                var lastPrice = myJson.lastPrice;
                                var fpaId = myJson.fpaId;

                                $('#q1Label').text(`Q1(${myJson.mainUnit})`);
                                $('#q2Label').text(`Q2(${myJson.buyUnit})`);
                                $('#VatPercent').val(rate);
                                $('#MaterialFpaId').val(fpaId);
                                $('#Price').val(lastPrice);
                                $('#MaterialFactor').val(myJson.factor);
                            }

                        })
                        .catch(error => console.log(error));
                    return false;
                }
                //_resizeMenu: function () { this.menu.element.outerWidth(300); }
                //open: function(event, ui)
                //{
                //    //$("#autocompleteID").autocomplete("widget").css("width", "300px");
                //    $('.ui-autocomplete').css('width', '300px');
                //}
            });

            $('#addToList').click((e) => {
                e.preventDefault();
                if ($.trim($("#Lookup").val()) == "" ||
                    $.trim($("#Price").val()) == "" ||
                    $.trim($("#Q1").val()) == "") return;

                var productName = $("#Lookup").val(),
                    price = $("#Price").val(),
                    quantity1 = $("#Q1").val(),
                    quantity2 = $("#Q2").val(),
                    discount = $("#Discount").val(),
                    materialId = $('#MaterialId').val(),
                    factor = $('#MaterialFactor').val(),
                    detailsTableBody = $("#detailsTable tbody");

                var productItem = '<tr><td class="small">' +
                    materialId +
                    '</td><td class="small" data-materialId="' + materialId + '"' +
                       'data-factor="' + factor + '"' +'>' +
                    productName +
                    '</td><td class="small">' +
                    price +
                    '</td><td class="small">' +
                    discount +
                    '</td><td class="small">' +
                    quantity1 +
                    '</td><td class="small">' +
                    quantity2 +
                    '</td><td class="small">' +
                    (parseFloat(price) * parseInt(quantity1)) +
                    '</td><td class="small"><a data-itemId="0" href="#" class="deleteItem">Remove</a></td></tr>';
                detailsTableBody.append(productItem);
                clearItem();
                $('#Lookup').focus();
            });

            //After Add A New Order In The List, Clear Clean The Form For Add More Order.
            function clearItem() {
                $("#Lookup").val('');
                $("#Price").val('');
                $("#Q1").val('');
                $("#Discount").val('');
                $("#VatPercent").val('');
            }
            $(document).on('click', 'a.deleteItem', function (e) {
                e.preventDefault();
                var $self = $(this);
                if ($(this).attr('data-itemId') == "0") {
                    $(this).parents('tr').css("background-color", "#ff6347").fadeOut(800, function () {
                        $(this).remove();
                    });
                }
            });
            //--------------------
            function saveData(data) {
                return $.ajax({
                    contentType: 'application/json; charset=utf-8',

                    dataType: 'json',
                    type: 'POST',
                   // url: "/Transactions/BuyMaterialsDoc/Create/AjaxPost",
                    url: "/api/Materials/MaterialBuyDoc",
                    data: data,
                    headers: {
                        'RequestVerificationToken': securityToken
                    },
                    success: function (result) {
                        toastr.success ("Success", "Success");
                        //alert("Success" + result);
                        //location.reload();
                    },
                    error: function (e) {

                        toastr.error ("Error", "Error");
                        //alert("Error" + e.message);
                    }
                });
            }
//-----------------
            $("#saveForm").click(function (e) {
                e.preventDefault();

                $('#thisForm').prop("disabled", true);

                var linesArr = [];
                linesArr.length = 0;

                $.each($("#detailsTable tbody tr"), function () {
                    linesArr.push({
                        materialId: $(this).find('td:eq(0)').html(),
                        materialId2: $(this).find('td:eq(1)').attr('data-materialId'),
                        factor: $(this).find('td:eq(1)').attr('data-factor'),
                        q1: $(this).find('td:eq(4)').html(),
                        price: $(this).find('td:eq(2)').html(),

                        amount: $(this).find('td:eq(5)').html()
                    });
                });

                var data = JSON.stringify({
                    transDate: $("#ItemVm_TransDate").val(),
                    transRefCode: $("#ItemVm_TransRefCode").val(),
                    buyDocLines: linesArr

                });
                console.log("Data->" + data);
                $.when(saveData(data))
                    .then(function (response) {
                        console.log(response);
                        $('#thisForm').prop("disabled", false);
                    })
                    .fail(function (err) {
                        console.log(err);
                        $('#thisForm').prop("disabled", false);
                    });
            });
            //-------------
        });


    </script>
}
